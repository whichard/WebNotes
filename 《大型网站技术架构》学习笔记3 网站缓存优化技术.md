## 网站优化

网站优化分为3大部分：前端性能优化，应用服务器性能优化和存储性能优化。

### 0. 缓存介绍

网站性能优化第一定律：优先考虑使用缓存优化性能。

缓存把数据存储在相对较高访问速度的存储介质中供系统处理。两个作用：减少数据访问时间，减少计算时间（如果缓存的数据是计算得到的结果）。**其本质是内存hash表键值对。**

回顾网站架构演化历程，当网站遇到性能瓶颈时，第一个想到的解决方案就是使用缓存。在整个网站应用中，缓存几乎无所不在，既存在于浏览器，也存在于应用服务器和数据库服务器；既可以对数据缓存，也可以对文件缓存，还可以对页面片段缓存。合理使用缓存，对网站性能优化意义重大。

使用缓存有两个前提条件，一是数据访问热点不均衡，某些数据会被更频繁的访问，这些数据应该放在缓存中；二是数据在某个时间段内有效，不会很快过期，否则缓存的数据就会因已经失效而产生脏读，影响结果的正确性。网站应用中，缓存除了可以加快数据访问速度，还可以减轻后端应用和数据存储的负载压力，这一点对网站数据库架构至关重要，网站数据库几乎都是按照有缓存的前提进行负载能力设计的。

缓存主要用来存放那些读写比很高、很少变化的数据，如商品的类目信息，热门词的搜索列表信息，热门商品信息等。应用程序读取数据时，先到缓存中读取，如果读取不到或数据已失效，再访问数据库，并将数据写入缓存。

#### 合理使用缓存

##### 频繁修改的数据不使用缓存

如果缓存中保存的是频繁修改的数据，就会出现数据写入缓存后，应用还来不及读取缓存，数据就已失效的情形，徒增系统负担。一般说来，数据的**读写比**在2：1以上，即**写入一次缓存，在数据更新前至少读取两次，缓存才有意义**。实践中，这个读写比通常非常高，比如新浪微博的热门微博，缓存以后可能会被读取数百万次。

##### 没有热点数据不使用缓存

网站数据访问通常遵循**二八定律**，即80%的访问落在20%的数据上，因此利用Hash表和内存的高速访问特性，将这**20%的数据缓存起来**，可很好地改善系统性能，提高数据读取速度，降低存储访问压力。如果数据不遵循二八定律，那么使用缓存将没有意义，只是徒占内存空间。

##### 数据不一致/脏读

如卖家已经编辑了商品属性，但是需要过一段时间才能被买家看到。在互联网应用中，这种延迟通常是可以接受的，但是具体应用仍需慎重对待。还有一种策略是数据更新时立即更新缓存，不过这也会带来更多系统开销和事务一致性的问题。

##### 缓存可用性 -- 应对缓存雪崩

缓存承担了大部分数据访问的压力，数据库已经习惯了有缓存的日子，所以当缓存服务崩溃时，数据库会因为完全不能承受如此大的压力而宕机，进而导致整个网站不可用。这种情况被称作**缓存雪崩**，发生这种故障，甚至不能简单地重启缓存服务器和数据库服务器来恢复网站访问。

实践中，有的网站通过**缓存热备**等手段提高缓存可用性：当某台缓存服务器宕机时，将缓存访问切换到热备服务器上。但是这种设计显然**有违缓存的初衷**，缓存根本就不应该被当做一个可靠的数据源来使用。

通过**分布式缓存服务器集群**，将缓存数据分布到集群多台服务器上可在一定程度上，**改善**缓存的可用性。当一台缓存服务器宕机的时候，只有部分缓存数据丢失，重新从数据库加载这部分数据不会对数据库产生很大影响。

##### 缓存预热

缓存系统启动时就把热点数据加载好

##### 缓存穿透

恶意攻击，持续请求一个不存在的数据。由于缓存没有保存该数据，请求将落到数据库上，造成数据库压力/崩溃。

应对：把不存在的数据也缓存起来，其value为null。

#### 分布式缓存 memcached的设计


通信协议tcp，序列化传输协议：基于文本，命令关键字 + 操作数  get <key> 

### 1. 前端优化

主要针对静态资源CSS，JavaScript，图片，静态网页。

#### 浏览器优化

- 减少http请求数量：合并。合并css，合并JavaScript，合并图片。 
- 浏览器缓存：设置HTTP头中Cache-Control和Expires的属。缓存CSS，JavaScript，图片。

- 压缩：在服务端压缩，浏览器端解压缩，减少数据传输量。在服务器资源不足时需要权衡。
- CSS在页面最上面，JavaScript在页面最下面！
  浏览器会在下载完全部Css之后才对整个页面进行渲染，因此最好的做法是将css放在页面最上面，让浏览器尽快下载css，JavaScript则相反，浏览器在加载JavaScript后立即执行，有可能会阻塞整个页面，造成页面显示缓慢，因此JavaScript最好放在页面最下面。但如果页面解析时就需要用到Javascript，这时放在底部就不合适了。

- 避免请求静态资源时发送Cookie，减少Cookie传输的次数。

#### cdn

其本质是缓存。使用cdn把静态资源缓存到离用户较近的网络节点。

#### 反向代理服务器缓存

其主要功能是服务端安全。

### 2. 后端优化

网站优化分为3大部分：前端性能优化，应用服务器性能优化和存储性能优化。

数据库优化 

---
